---
title: "Introduction to Data Science"
subtitle: "Session 4: Relational databases and SQL"
author: "Simon Munzert"
institute: "Hertie School | [GRAD-C11/E1339](https://github.com/intro-to-data-science-21)" #"`r format(Sys.time(), '%d %B %Y')`"
output:
  xaringan::moon_reader:
    css: [default, 'simons-touch.css', metropolis, metropolis-fonts] 
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: '16:9'
      hash: true
---


```{css, echo=FALSE} 
@media print { # print out incremental slides; see https://stackoverflow.com/questions/56373198/get-xaringan-incremental-animations-to-print-to-pdf/56374619#56374619
  .has-continuation {
    display: block !important;
  }
}
```

```{r setup, include=FALSE}
# figures formatting setup
options(htmltools.dir.version = FALSE)
library(knitr)
opts_chunk$set(
  prompt = T,
  fig.align="center", #fig.width=6, fig.height=4.5, 
  # out.width="748px", #out.length="520.75px",
  dpi=300, #fig.path='Figs/',
  cache=T, #echo=F, warning=F, message=F
  engine.opts = list(bash = "-l")
  )

## Next hook based on this SO answer: https://stackoverflow.com/a/39025054
knit_hooks$set(
  prompt = function(before, options, envir) {
    options(
      prompt = if (options$engine %in% c('sh','bash')) '$ ' else 'R> ',
      continue = if (options$engine %in% c('sh','bash')) '$ ' else '+ '
      )
})

library(tidyverse)
```


# Table of contents

1. [Back to dplyr: joins](#joins)

2. [Relational data](#relational)

3. [Database fundamentals](#databases)

4. [SQL](#sql)

5. [Databases and R](#dbr)

6. [Other database types](#otherdb)

7. [Summary](#summary)




---

# When databases become useful

.pull-left[
- You want to present or make data available on a website. Using a database, you only need one tool to achieve this.
- You collaborate with others on a data collection project. With a database, you have a common, always accessible, and reliable infrastructure at hand that multiple users can access at the same time.
- When several parties are involved, who is allowed to do what with the database might differ (e.g., read-only, access to parts of the data, limited admin rights, etc.). Most databases allow defining different usage rights for different users.
]

--

.pull-right[
- You have loads of data that exceed the working memory on your computer. Databases are limited by available disk size (or can be distributed across multiple disks/machines).
- Your data structure is complex. Databases allow/encourage you to store, retrieve and subset data with complex data structures.
- Your data is big and you have to access/subset/operate frequently. Querying databases is fast.
- You care about data quality and have clear expectations how data should look like. Using databases you can define specific rules for extending and updating your database.
]

---

# Getting some terminology right

## We should distinguish:

- The **data structure**: tables, columns, keys, normal forms
- The **data manipulations**: selects, joins, grouping
- The **database management system**: e.g., Postgres, Oracle, SQL Server, sqlite
- The **query language**, e.g., SQL

## What we will cover and won't cover

- We will cover essential structures and manipulations, how to interact with databases from within R, and basics of SQL
- We will not cover SQL or any particular database system in detail


dbms-r-sql.png


---

# Why databases?

- Big data, big problems
- Store data which is too big to fit into memory
- Access big data effectively

# Where are the databases

Databases can exist
- locally or remotely
- in-memory or on-disk

# Why are databases so efficient?

- They rely on binary search trees https://en.wikipedia.org/wiki/Binary_search_tree
- But also see hash tables: https://en.wikipedia.org/wiki/Hash_table
- Analogy: (Relational) databases organize data in one more tables. Think of a list of data frames in R. To access information from a specific table (data frame), we first have to index it from the database (list) and then execute our query functions
- Another useful analogy (from McDermott): A b-tree shares the spirit of the file cabinet ordering system, but takes it step further so that we eliminate at least half of the remaining data from our search at each step. E.g. We need to find a person’s tax records in a million-row dataset. In the first step we immediately realise that it’s somewhere in the first 500k rows. In the next step we immediately realise that it’s somewhere in rows 250k-500k, etc.


---

# Connecting to databases with R

- R can connect to all major existing databases types (and to virtually anything else, too).
- There are various R packages that allow you to connect to particular database types, e.g.:

| DBMS  |  R package |
|---|---|
| SQLite  | [`RSQLite`](https://cran.r-project.org/web/packages/RSQLite/index.html) |
| MySQL  | [`RMySQL`](https://cran.r-project.org/web/packages/RMySQL/index.html) |
|  PostgreSQL |  [`RPostgres`](https://cran.r-project.org/web/packages/RPostgres/index.html) |
|  Oracle Database |  [`ROracle`](https://cran.r-project.org/web/packages/ROracle/index.html) |



---

# A common interface to relational databases from R

https://cran.r-project.org/web/packages/DBI/vignettes/DBI-proposal.html
https://db.rstudio.com/getting-started/overview
https://en.wikipedia.org/wiki/Database#Database_management_system
https://www.dataquest.io/blog/sql-basics/




---
class: inverse, center, middle
name: joins

# Back to dplyr: joins

<html><div style='float:left'></div><hr color='#EB811B' size=1px style="width:1000px; margin:auto;"/></html>


---

# Relational data in R

For the simple examples that I'm going to show here, we'll need some data sets that come bundled with the [**nycflights13**](http://github.com/hadley/nycflights13) package. 

Let's load it now and then inspect these data frames in your own console.

```{r flights, echo = F}
library(nycflights13)
```
```{r, eval = F}
library(nycflights13)
flights 
planes
```

---
# Relational data in R (cont.)

The package contains the tables `airlines`, `airports`, `flights`, `planes`, and `weather`.

--

.pull-left[
The `airlines` data frame lets you look up the full carrier name from its [abbreviated code](https://en.wikipedia.org/wiki/List_of_airline_codes): 
```{r}
head(airlines, 10)
```
]
--

.pull-right[
`airports` gives information about each airport, identified by the `faa` [airport code](https://airportcodes.io/en/faa-codes/): 
```{r}
head(airports, 10)
```
]



---
# Relational data in R (cont.)

The package contains the tables `airlines`, `airports`, `flights`, `planes`, and `weather`.

.pull-left[
 `planes` gives information about each plane, identified by its `tailnum` (aircraft registration a.k.a. [tail number](https://en.wikipedia.org/wiki/Aircraft_registration): 
```{r}
head(planes, 10)
```
]

--

.pull-right[
`weather` gives the [weather](https://www.youtube.com/watch?v=1ZyT_Aiey1U) at each NYC airport for each hour: 
```{r}
head(weather, 10)
```
]

FINALLY, FLIGHTS TABLE

THEN: CONCEPTUAL TABLE


---

# Joins

One of the mainstays of the dplyr package is merging data with the family [join operations](https://cran.r-project.org/web/packages/dplyr/vignettes/two-table.html).
- `inner_join(df1, df2)`
- `left_join(df1, df2)`
- `right_join(df1, df2)`
- `full_join(df1, df2)`
- `semi_join(df1, df2)`
- `anti_join(df1, df2)`


---

# Joins *cont.*

Let's perform a [left join](https://stat545.com/bit001_dplyr-cheatsheet.html#left_joinsuperheroes-publishers) on the flights and planes datasets. 
- *Note*: I'm going subset columns after the join, but only to keep text on the slide.

--

```{r join1}
left_join(flights, planes) %>%
  select(year, month, day, dep_time, arr_time, carrier, flight, tailnum, type, model)
```

---

# Joins *cont.*

(*continued from previous slide*)

Note that dplyr made a reasonable guess about which columns to join on (i.e. columns that share the same name). It also told us its choices: 

```
*## Joining, by = c("year", "tailnum")
```

However, there's an obvious problem here: the variable "year" does not have a consistent meaning across our joining datasets!
- In one it refers to the *year of flight*, in the other it refers to *year of construction*.

--

Luckily, there's an easy way to avoid this problem. 
- See if you can figure it out before turning to the next slide.
- Try `?dplyr::join`.

---

# Joins *cont.*

(*continued from previous slide*)

You just need to be more explicit in your join call by using the `by = ` argument.
- You can also rename any ambiguous columns to avoid confusion. 
```{r join2}
left_join(
  flights,
  planes %>% rename(year_built = year), ## Not necessary w/ below line, but helpful
  by = "tailnum" ## Be specific about the joining column
  ) %>%
  select(year, month, day, dep_time, arr_time, carrier, flight, tailnum, year_built, type, model) %>%
  head(3) ## Just to save vertical space on the slide
```

---

# Joins *cont.*

(*continued from previous slide*)

Last thing I'll mention for now; note what happens if we again specify the join column... but don't rename the ambiguous "year" column in at least one of the given data frames.
```{r join3}
left_join(
  flights,
  planes, ## Not renaming "year" to "year_built" this time
  by = "tailnum"
  ) %>%
  select(contains("year"), month, day, dep_time, arr_time, carrier, flight, tailnum, type, model) %>%
  head(3)
```

--

Make sure you know what "year.x" and "year.y" are. Again, it pays to be specific.





---
class: inverse, center, middle
name: relational

# Relational data

<html><div style='float:left'></div><hr color='#EB811B' size=1px style="width:1000px; margin:auto;"/></html>



---

# The ubiqity of multi-dimensional data structures

.pull-left[
## From data frames...

- When you have a background in social sciences, your top-of-the-head mental image of data might be a rectangular spread sheet.
- In fact, much of classical "statistical" software (SPSS, Stata, MS Excel) operates with rectangular data frames by default. 
- At the same time, your perception might be file-based. Data is stored in files, and these files are read (and produced) by our data management software.
- In many cases, the two-dimensional structure makes sense. We observe persons x characteristics, countries x variables, social media posts x text features, etc.
]

--

.pull-right[
## ... to more complex data structures

- However, the longer you think about it, the more problematic it becomes to store your data in two-dimensional structures.
- Examples:
  - countries x persons x characteristics x time
  - countries x states x communities x time x variables
  - social media posts x retweets x users x user characteristics x network features x meta data 
- Mapping three- onto two-dimensional structures is easy (think: `pivot_longer`, `pivot_wider`).
- With multiple heterogeneous data sources, things get messy.
]


---

# Relational data for the win








---
class: inverse, center, middle
name: databases

# Database fundamentals

<html><div style='float:left'></div><hr color='#EB811B' size=1px style="width:1000px; margin:auto;"/></html>


---
class: inverse, center, middle
name: sql

# SQL

<html><div style='float:left'></div><hr color='#EB811B' size=1px style="width:1000px; margin:auto;"/></html>


---
class: inverse, center, middle
name: dbr

# Databases and R

<html><div style='float:left'></div><hr color='#EB811B' size=1px style="width:1000px; margin:auto;"/></html>


---
class: inverse, center, middle
name: otherdb

# Other database types

<html><div style='float:left'></div><hr color='#EB811B' size=1px style="width:1000px; margin:auto;"/></html>


---
# Non-relational databases






---
class: inverse, center, middle
name: summary

# Summary

<html><div style='float:left'></div><hr color='#EB811B' size=1px style="width:1000px; margin:auto;"/></html>

---
# Summing it up

Most data scientists never design a database. 

- But they almost all end up interacting with them.
- Also, with database administrators (DBAs).

--

Lots of academic data work consists of working with *bad reinventions* of the relational database.

- Looking at you, Excel users.
- Looking at you, instructor.

-- 

Surprise: Thinking about data relationally will help you with statistics.

- Multilevel models, time-series analysis, network analysis, NLP

| Database concept  |  Statistical concept |
|---|---|
| Table  | Sample |
| Column  | Variable |
|  Row |  Unit |
|  Value |  Observation |
|  Foreign key relationships |  Nested variables |
|  Many-to-many relationships |  Crossed variables (possibly unbalanced) |


---
# Databases: Maybe not the most exciting technology, but awesomely useful and not going away


---

# Coming up


### Assignment

None! But you'll get the chance to practice databasing with R in the lab.


### Next lecture

Web data and technologies - relational data structures FTW!


